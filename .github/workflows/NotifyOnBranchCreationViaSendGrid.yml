name: Notify on Branch Creation (SendGrid via Node)

# Trigger when a branch or tag is created
on:
  create: {}

jobs:
  branch-created:
    # Only run for branches, not tags
    if: ${{ github.event.ref_type == 'branch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Verify sendgrid.js is present
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -la .github || true
          if [ -f .github/sendgrid.js ]; then
            echo ".github/sendgrid.js found"
          else
            echo "Error: .github/sendgrid.js not found"
            exit 1
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install SendGrid SDK
        run: |
          npm init -y
          npm install @sendgrid/mail --no-audit --no-fund --silent

      - name: Send email via SendGrid (node)
        env:
          # Primary API key; also set INPUT_API-KEY for compatibility with your script
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          INPUT_API-KEY: ${{ secrets.SENDGRID_API_KEY }}

          # Recipient/sender and message content (store these secrets in the repo or org)
          INPUT_TO: ${{ secrets.EMAIL_TO }}
          INPUT_FROM: ${{ secrets.EMAIL_FROM }}

          # Compose subject/body using GitHub context
          INPUT_SUBJECT: "New branch created: ${{ github.ref_name }}"
          INPUT_BODY: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Created by: ${{ github.actor }}
            Link: https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}
        run: node .github/sendgrid.js
